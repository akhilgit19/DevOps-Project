-Build and Deploy series: The Series here does not focus on individual tools but focuses more on how different DevOps tools are connected to each other




Jenkins Server---ssh----- Build Server --------ssh----- deplyserver

                          Ansible
                         build.sh deploy.sh
- click on launch instance
- name- jenkins
- ubuntu-os
- keypair- react-nginx-aws-deploy
- T3 micro
- allow ssh port 22 for ipv4/ipv6 0.0.0.0/0
- allow custom tcp port 8080 for jenkins 0.0.0./0


sudo apt update
sudo apt install fontconfig openjdk-17-jre
java -version
Copy
Now lets install jenkins

sudo wget -O /usr/share/keyrings/jenkins-keyring.asc \
  https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc]" \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null
sudo apt-get update
sudo apt-get install jenkins
Copy
Verify Jenkins installation by command
jenkins --version
Copy


Now let us enable jenkins so that even if system is rebooted, jenkins runs as soon as system
is up , also start jenkins and check status of jenkins

sudo systemctl enable jenkins
sudo systemctl start jenkins
sudo systemctl status jenkins
Copy


Now lets configure Jenkins, Jenkins by default runs on port 8080

Add 8080 to inbound rules of AWSEC2 server in which jenkins is running


Now your jenkins URL will be http://{AWS_PUBLIC_IP}:8080,access this URL to configure jenkins and If you are accessing for first time, you will be displayed this page




Now get the password from your AWS EC2 server by running command
sudo cat /var/lib/jenkins/secrets/initialAdminPassword
Copy


Copy and paste the password in jenkins page, once password is authenticated


go with install suggested plugins, we can install custom plugins later based on requirement


its recommended to create an Admin user


and then 


since our public Ip changes, everytime as we are not using AWS elastic IP, i will be skipping this step

Our final page after configuration

We configure jenkins successfully


Only for first time, we need to configure jenkins from next time, we will login with username and password that we created as first admin


you can login with First admin user created or you can give username as admin and password is the password fetched from /var/lib/jenkins/secrets/initialAdminPassword when we initially logged in



Now before we began, In last project we have used installed Ansible in BuildServer and we have written two playbooks inside Buildserver, we asked ansible to run build.yaml in BuildServer and deploy.yaml in DeployServer, we triggered both the playbooks from inside BuildServer 

Now lets make a connection between JenkinsServer and BuildServer,so we can ask Jenkins to run ansible playbooks that are inside BuildServer

We will switch to Jenkins user and generate key-pair

sudo su - jenkins
Copy
ssh-keygen
Copy


as you can see from above screenshot keys were created in path /var/lib/jenkins/.ssh, get the contents of public key from that path


copy the contents of public key and log in to BuildServer
sudo vi /home/ubuntu/.ssh/authorized_keys
Copy


Now come back to Jenkins server, and let us test the connection, copy AWS private IP of BuildServer and test connection
ssh ubuntu@{BuildServer_Private_IP}
Copy


now we are inside buildserver from JenkinsServer, type exit to come back to our Jenkins Server
exit
Copy


Build and Deploy of React Application
since we established connection, let us write our Jenkinsfile first


pipeline {
    agent any
    
    stages {
        stage('Build Docker images on Build Server') {
            steps {
                script {
                    // Execute Ansible playbook on Build Server
                    sh "ssh ubuntu@172.31.42.119 'ansible-playbook /home/ubuntu/build.yaml'"                    // 'ansible-playbook /home/ubuntu/playbook.yaml'"
                
                    
                    }
            }
        }
        
        stage('Deploy Script on Deploy Server') {
            steps {
                script {
                    // Execute deployment playbook on Deploy Server
                    sh "ssh ubuntu@172.31.42.119 'ansible-playbook /home/ubuntu/deploy.yaml'"
                }
            }
        }
    }
}
Copy

In the above jenkins file, agent- any is where we are asking jenkins to run on any nodes that are available. since we have not configured any nodes, these pipelines will run on master jenkins server. ".sh" indicates shell and command followed by it indicates jenkins to login to buildserver and run playbook build.yaml in stage-1 and run playbook deploy.yaml in stage-2, the IP mentioned is Private IP address of Build Server

Now, lets include this file in the Github react project in which we want to deploy
name it as Jenkinsfile



Now go back to our Jenkins URL. click on New item




give a name and click on pipeline project



now make sure to select this option as we will use webhooks



click on dropdown and change it to Pipeline from SCM



then select git in SCM and copy our react project git URL, you can leave credentials to none as it is public repository



change branch specifier to branch in which jenkinsfile is present and script path to name of jenkinsfile you gave


since in our case it is main branch and Jenkinsfile, we will make changes accordingly


click on apply and save

Click on Buildnow for pipeline to start

This is manual build and deployment

Since we want to automate Build and Deployment whenever developer commits code, we will use webhooks

Go to your Github repo for which we want deployment

click on settings

click on Webhooks and add Webhook

Add http://{AWS_EC2_Public_ip}:8080/github-webhook/ , here AWS EC2 Public IP refers to server in which Jenkins is installed


change content type to application/json and add webhook


Now we have configured Webhook with push event, this means whenever code is pushed to repository.

Jenkins will trigger pipeline as we have selected Github hook trigger for Git scm polling while configuring pipeline

let us test this by making changes in our code,as of now our website looks like this



And now let us use change in code from testsss for Hands to Testing for Demo


As soon as i commited code, jenkins triggered pipeline because of webhook  configuration that we made.






As soon as pipeline finished, our website updated.



Build and Deployment is successfully completed using Jenkins Pipeline

if you want to check logs of pipeline 

click on number here like #1 or #2


click on Console output , you can check logs even when pipeline is running.





With this Our Build and Deploy Series has been completed
================


Last login: Sat Aug 31 11:45:12 on ttys000
akhilpagadapoola@Akhils-MacBook-Air Jenkins_keypair % ssh -i "Jenkins.pem" ubuntu@ec2-54-164-216-250.compute-1.amazonaws.com

ubuntu@ip-172-31-94-156:~$ sudo apt update
sudo apt install fontconfig openjdk-17-jre
java -version

ubuntu@ip-172-31-94-156:~$ sudo wget -O /usr/share/keyrings/jenkins-keyring.asc \
  https://pkg.jenkins.io/debian-stable/jenkins.io-2023.key
echo "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc]" \
  https://pkg.jenkins.io/debian-stable binary/ | sudo tee \
  /etc/apt/sources.list.d/jenkins.list > /dev/null
sudo apt-get update
sudo apt-get install jenkins

ubuntu@ip-172-31-94-156:~$ jenkins --version
2.462.1
ubuntu@ip-172-31-94-156:~$ sudo systemctl enable jenkins
sudo systemctl start jenkins
sudo systemctl status jenkins

lines 1-20/20 (END)
[1]+  Stopped                 sudo systemctl status jenkins
ubuntu@ip-172-31-94-156:~$ sudo cat /var/lib/jenkins/secrets/initialAdminPassword
8e666d5a68214899a82362c2577d65a7

ubuntu@ip-172-31-94-156:~$ sudo su - jenkins
jenkins@ip-172-31-94-156:~$ ssh-keygen
Generating public/private ed25519 key pair.
Enter file in which to save the key (/var/lib/jenkins/.ssh/id_ed25519): 
Created directory '/var/lib/jenkins/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /var/lib/jenkins/.ssh/id_ed25519
Your public key has been saved in /var/lib/jenkins/.ssh/id_ed25519.pub
The key fingerprint is:
SHA256:8XPsnoFlV5AUpAFJeyK8j/Ll1F/cLGaQy93oxFxgm6A jenkins@ip-172-31-94-156
The key's randomart image is:
+--[ED25519 256]--+
|         .oo.o=o |
|       .  .. o.. |
|        + o + o .|
|         = = + = |
|        S E B + .|
|         o X B *.|
|      . . = * X *|
|       o + . O o |
|        . . o o  |
+----[SHA256]-----+
jenkins@ip-172-31-94-156:~$ cd .ssh
jenkins@ip-172-31-94-156:~/.ssh$ ls
id_ed25519  id_ed25519.pub
jenkins@ip-172-31-94-156:~/.ssh$ cat id_ed25519.pub
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIEdxVny09IV/1oniFSKELxQkkFlfhGD+8jhF7pYGFlL jenkins@ip-172-31-94-156

Last login: Thu Aug 29 05:18:39 2024 from 49.43.217.177
ubuntu@ip-172-31-80-228:~$ exit
logout
Connection to 172.31.80.228 closed.
jenkins@ip-172-31-86-238:~$ 



Now connect to build server and add the pub key:

ubuntu@ip-172-31-87-138:~$ sudo vi /home/ubuntu/.ssh/authorized_keys
ubuntu@ip-172-31-87-138:~$ sudo su - root
root@ip-172-31-87-138:~# sudo su - ubuntu
ubuntu@ip-172-31-87-138:~$ 

get back to jenkins server and check the connectiviity:

jenkins@ip-172-31-94-156:~/.ssh$ ssh -i /var/lib/jenkins/.ssh/id_ed25519 ubuntu@172.31.87.138


Last login: Sat Aug 31 07:27:54 2024 from 49.43.217.48
ubuntu@ip-172-31-87-138:~$ exit
logout
Connection to 172.31.87.138 closed.
jenkins@ip-172-31-94-156:~/.ssh$ client_loop: send disconnect: Broken pipe
akhilpagadapoola@Akhils-MacBook-Air Jenkins_keypair % 



- click on new item
- jobname - react-demo
- description
- build triggers- github hook trigger for SCM polling
- pipeline
  Defintion- pipeline script from  SCM
- SCM-  Git
- Repositories
  - https://github.com/akhilgit19/Gold_Site_Ecommerce-1

-
Pipeline

Jenkins file

pipeline {
    agent any
    
    stages {
        // Uncomment the below stage if you configured SonarQube
        stage('Run Sonarqube') {
            environment {
                scannerHome = tool 'sonarqubescanner'
            }
            steps {
                withSonarQubeEnv(credentialsId: 'sonarqubetoken', installationName: 'sonarqubeserver') {
                    sh "${scannerHome}/bin/sonar-scanner"
                }
            }
        }
        stage('Build Docker images on Build Server') {
            steps {
                script {
                    // Execute Ansible playbook on Build Server
                    sh "ssh ubuntu@172.31.93.4 'ansible-playbook /home/ubuntu/build.yaml'"                    // 'ansible-playbook /home/ubuntu/playbook.yaml'"
                
                    
                    }
            }
        }
        
        stage('Deploy Script on Deploy Server') {
            steps {
                script {
                    // Execute deployment playbook on Deploy Server
                    sh "ssh ubuntu@172.31.93.4 'ansible-playbook /home/ubuntu/deploy.yaml'"
                }
            }
        }
    }
}


Github:
- In setings
- developer setting
- webhook 
- payload URL
  http://16.16.67.42:8080/github-webhoo/
- contenty type
  application/json
- click on webhook
