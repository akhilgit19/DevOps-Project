
Build of React Application
##Note: Bash scripts must be saved with .sh and first line to be #!/bin/bash except first line "#" is considered to be a comment###
 Now our goal here is to Build docker image in AWS EC2 server and push it to Docker hub

 we will write a simple bash script to automate our process

 we will be deleting our existing images to save some space, generally this is not recommended, i am running this as  i don't want to get space issue for docker images to be piled up whenever we run build

we can pull the existing repository, but in this, i am deleting and re-creating git to update latest repository

i am running the script as i can use the same script to deploy in new servers if needed

code:

#!/bin/bash
sudo docker rmi -f $(sudo docker images -q) ##this is not recommned step, i am deleting existing images to save space
sudo rm -r gold ## these steps are not recommened instead you can modify script as shown below
sudo mkdir gold
cd gold/
sudo git clone https://github.com/Hari0o/Gold_Site_Ecommerce.git
cd Gold_Site_Ecommerce/
sudo docker build -t react-nginx -f golddockerfile .
sudo docker tag react-nginx:latest reactdemo/react-nginx:latest ##make sure you did docker login
sudo docker push reactdemo/react-nginx:latest

##recommended script###
#!/bin/bash
#cd gold/Gold_Site_Ecommerce
#sudo git pull
#sudo docker build -t react-nginx -f goldockerfile .
#sudo docker tag react-nginx:latest reactdemo/react-nginx:latest ##make sure you did docker login
#sudo docker push reactdemo/react-nginx:latest


save the script in file that ends with .sh, in our case, we saved it as build.sh

As we see, build.sh folder has root as owner



Now give permissions to the file, since we will be running our scripts from ubuntu, let us change ownership from root to ubuntu by command
sudo chown ubuntu build.sh
Copy

Now let us give execute permissions for script to run
 sudo chmod 744 build.sh
Copy


Now let us run the script if you are in the same path of script you can run ./build.sh,if you are in different path use full path of script like /home/ubuntu/build.sh and In ./build.sh "." represents present working directory
/home/ubuntu/build.sh
Copy


once script is run, you can verify latest images by sudo docker images

sudo docker images
Copy


Alternately, you can check your docker hub account

Verify latest push time,this shows our Build has been successful and pushed to docker image.

Now to avoid confusion, let us rename our AWS-EC2 server in which we have built our docker images to BuildServer and and our server in which we are running kubernetes to DeployServer



Deployment of React Application

Since we have already made setup as Part-3, we will restart pods, so that when pod is up,
it fetches latest image from Dockerhub.

We will write a Bash script inside our Deploy server to restart pods
Since we have placed pods in Deployment, Deleting existing pods will bring up new pods automatically


#!/bin/bash
pods_id=$(microk8s kubectl get pods -n react-nginx |grep react |awk {'print $1'})
microk8s kubectl delete pod $pods_id -n react-nginx 
Copy
Change the namespace to the name you have given according to last project

in the above script pods_id is variable and it helps to get pod_ids in deployment
second command deletes the existing pods, this lets kubernetes deployment to bring up new pods

change ownership of our script file to ubuntu or change it to any user you want to run script with
sudo chown ubuntu deploy.sh
Copy



Now give execute permissions for file to run
sudo chmod 744 deploy.sh
Copy



if you are in same directory as that of script, we can simply run the command by
./deploy.sh
Copy


Now check deployment if pods are restarted or not by command
since we are in microk8s run alias command that is specified in part-3,

kubectl get pods -n react-nginx
Copy


Our Deployment is successful

Note: Helm Charts are recommended way to Deploy kubernetes,to put in simple words Helm charts are like package of your complete kubernetes, It will re-install our kubernetes components like ingress service,deployment and all that are actually required to make our application up.We will talk about Helm Charts in upcoming projects

I have only used restart pod to show that pod restart would fetch image from container registry.

This Bash script would not help us if we have change in service or ingress file. either we can use commands to update these components individually else we can drop all the components into helm charts and then updating helm with single command

In this complete series, i will be using only the pod restart method as an deployment part



Domain visibility

Go for AWS EC2, security groups and In inbound rules allow port 80, as our nginx listens on port 80




==============================================
ubuntu@ip-172-31-80-228:~$ ls
Gold_Site_Ecommerce-1
ubuntu@ip-172-31-80-228:~$ sudo vi build.sh
ubuntu@ip-172-31-80-228:~$ cat build.sh
#!/bin/bash
sudo docker rmi -f $(sudo docker images -q) ##this is not recommned step, i am deleting existing images to save space
sudo rm -r gold ## these steps are not recommened instead you can modify script as shown below
sudo mkdir gold
cd gold/
sudo git clone https://github.com/akhilgit19/Gold_Site_Ecommerce-1.git
cd Gold_Site_Ecommerce-1/
sudo docker build -t react-nginx-image -f golddockerfile .
sudo docker tag react-nginx-image:latest akhilpagadapoola/react-nginx:latest ##make sure you did docker login
sudo docker push akhilpagadapoola/react-nginx:latest

##recommended script###
#!/bin/bash
#cd gold/Gold_Site_Ecommerce
#sudo git pull
#sudo docker build -t react-nginx -f goldockerfile .
#sudo docker tag react-nginx:latest reactdemo/react-nginx:latest ##make sure you did docker login
#sudo docker push reactdemo/react-nginx:latest
ubuntu@ip-172-31-80-228:~$ ./build.sh
-bash: ./build.sh: Permission denied
ubuntu@ip-172-31-80-228:~$ sudo chown ubuntu build.sh
ubuntu@ip-172-31-80-228:~$  sudo chmod 744 build.sh
ubuntu@ip-172-31-80-228:~$ ls -lhtr
total 8.0K
drwxrwxr-x 5 ubuntu ubuntu 4.0K Aug 28 14:57 Gold_Site_Ecommerce-1
-rwxr--r-- 1 ubuntu root    848 Aug 28 17:17 build.sh
ubuntu@ip-172-31-80-228:~$ ./buld.sh
-bash: ./buld.sh: No such file or directory
ubuntu@ip-172-31-80-228:~$ ./build.sh
Untagged: akhilpagadapoola/react-nginx:latest
Untagged: akhilpagadapoola/react-nginx@sha256:a4557dca9dd440e064ef77f84cce2e2049906efcbc062c11b329b40deab41d35
Untagged: react-nginx:latest
Deleted: sha256:e317f46a495b7155ebb0c24d9ddd5c3871ed7f7d7857ad0a95bcaeb2b4e9eb0e
Error response from daemon: No such image: e317f46a495b:latest
rm: cannot remove 'gold': No such file or directory
Cloning into 'Gold_Site_Ecommerce-1'...
remote: Enumerating objects: 108, done.
remote: Counting objects: 100% (108/108), done.
remote: Compressing objects: 100% (105/105), done.
remote: Total 108 (delta 35), reused 57 (delta 2), pack-reused 0 (from 0)
Receiving objects: 100% (108/108), 1.08 MiB | 27.06 MiB/s, done.
Resolving deltas: 100% (35/35), done.
[+] Building 47.5s (16/16) FINISHED                                                                                                                                docker:default
 => [internal] load build definition from golddockerfile                                                                                                                     0.0s
 => => transferring dockerfile: 570B                                                                                                                                         0.0s
 => [internal] load metadata for docker.io/library/node:18                                                                                                                   0.1s
 => [internal] load metadata for docker.io/library/nginx:alpine                                                                                                              0.2s
 => [auth] library/node:pull token for registry-1.docker.io                                                                                                                  0.0s
 => [auth] library/nginx:pull token for registry-1.docker.io                                                                                                                 0.0s
 => [internal] load .dockerignore                                                                                                                                            0.0s
 => => transferring context: 2B                                                                                                                                              0.0s
 => [stage-1 1/2] FROM docker.io/library/nginx:alpine@sha256:c04c18adc2a407740a397c8407c011fc6c90026a9b65cceddef7ae5484360158                                                0.0s
 => [buildmachine 1/6] FROM docker.io/library/node:18@sha256:a7ff16657263663c1e92ba3060cdbba0e77329a0a4cb3c27bbbbe90c6e20bd87                                                0.0s
 => [internal] load build context                                                                                                                                            0.1s
 => => transferring context: 3.24MB                                                                                                                                          0.1s
 => CACHED [buildmachine 2/6] WORKDIR /app                                                                                                                                   0.0s
 => CACHED [buildmachine 3/6] COPY package*.json ./                                                                                                                          0.0s
 => CACHED [buildmachine 4/6] RUN npm install                                                                                                                                0.0s
 => [buildmachine 5/6] COPY . .                                                                                                                                              0.1s
 => [buildmachine 6/6] RUN npm run build                                                                                                                                    45.3s
 => CACHED [stage-1 2/2] COPY --from=buildmachine /app/build /usr/share/nginx/html                                                                                           0.0s 
 => exporting to image                                                                                                                                                       0.0s 
 => => exporting layers                                                                                                                                                      0.0s 
 => => writing image sha256:e317f46a495b7155ebb0c24d9ddd5c3871ed7f7d7857ad0a95bcaeb2b4e9eb0e                                                                                 0.0s 
 => => naming to docker.io/library/react-nginx-image                                                                                                                         0.0s 
The push refers to repository [docker.io/akhilpagadapoola/react-nginx]                                                                                                            
2ecdf87182a7: Layer already exists 
26d9c9583797: Layer already exists 
2cdd4bacf827: Layer already exists 
f3719eb0da5e: Layer already exists 
9a2d14b22cbe: Layer already exists 
16f2939def51: Layer already exists 
b65aff7ee426: Layer already exists 
c028c01f43bc: Layer already exists 
78561cef0761: Layer already exists 
latest: digest: sha256:a455
ubuntu@ip-172-31-94-133:~$ microk8s kubectl get ns
NAME                    STATUS   AGE
default                 Active   69m
ingress                 Active   55m
kube-node-lease         Active   69m
kube-public             Active   69m
kube-system             Active   69m
react-nginx-namespace   Active   60m
ubuntu@ip-172-31-94-133:~$ cat deploy.sh
#!/bin/bash
pods_id=$(microk8s kubectl get pods -n react-nginx-namespace |grep react |awk {'print $1'})
microk8s kubectl delete pod $pods_id -n react-nginx-namespace
ubuntu@ip-172-31-94-133:~$ ls -lhtr
total 20K
drwx------ 3 ubuntu ubuntu 4.0K Aug 28 16:15 snap
-rw-r--r-- 1 root   root    398 Aug 28 16:23 react-deployment.yaml
-rw-r--r-- 1 root   root    195 Aug 28 16:27 react-service.yaml
-rw-r--r-- 1 root   root    325 Aug 28 16:33 react-ingress.yaml
-rw-r--r-- 1 ubuntu root    166 Aug 28 17:22 deploy.sh
ubuntu@ip-172-31-94-133:~$    sudo chmod 744 deploy.sh
ubuntu@ip-172-31-94-133:~$ ./deploy.sh
pod "react-deployment-59597c6899-mtkwh" deleted
pod "react-deployment-59597c6899-xgl5f" deleted
ubuntu@ip-172-31-94-133:~$ kubectl get pods -n react-nginx-namespace
Command 'kubectl' not found, but can be installed with:
sudo snap install kubectl
ubuntu@ip-172-31-94-133:~$ microk8s kubectl get pods -n react-nginx-namespace
NAME                                READY   STATUS    RESTARTS   AGE
react-deployment-59597c6899-hzqfp   1/1     Running   0          54s
react-deployment-59597c6899-p2g2w   1/1     Running   0          54s
ubuntu@ip-172-31-94-133:~$ ./deploy.sh
pod "react-deployment-59597c6899-hzqfp" deleted
pod "react-deployment-59597c6899-p2g2w" deleted
^[[A^[[Aubuntu@ip-172-31-94microk8s kubectl get pods -n react-nginx-namespace
NAME                                READY   STATUS    RESTARTS   AGE
react-deployment-59597c6899-7xjh6   1/1     Running   0          11s
react-deployment-59597c6899-msh8h   1/1     Running   0          12s
